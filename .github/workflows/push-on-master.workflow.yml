name: Create Changelog and Release from Integration

on:
  push:
    branches:
      - develop

jobs:

  create-changelog-and-release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci skip') && !contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - uses: actions/checkout@v2
        with:
          # we need this, to circumflex eh -vent branch protection
          token: ${{ secrets.AUTH_TOKEN }}
      - name: Prepare repository
        run: git fetch --unshallow --tags
      # create release branch and merge master into it, to get latest tags
      - name: create release branch
        run: git checkout -b release-master
      - name: merge master into release-master to get latest tags
        run: git merge master
      - name: Use Node.js 14.x
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: install pnpm
        run: npm i -g pnpm
      - name: bootstrap monorepo
        run: pnpm i -r
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.AUTH_TOKEN }}
        run: pnpm run publish-all
      - name: checkout master
        run: git checkout master
      - name: merge master
        run: git merge master
