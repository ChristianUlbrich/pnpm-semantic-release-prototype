name: Create Changelog and Release from Integration

on:
  push:
    branches:
      - develop

jobs:

  create-changelog-and-release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci skip') && !contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - uses: actions/checkout@v2
        with:
          # we need this, to circumflex eh -vent branch protection
          token: ${{ secrets.AUTH_TOKEN }}
      - name: Prepare repository
        run: git fetch --unshallow --tags
      # create release branch and merge master into it, to get latest tags
      - name: create release branch
        run: git checkout -b release-master
      - name: merge master into release-master to get latest tags
        run: git merge master
      # create actual release and thus commits on release-master
      - name: Use Node.js 14.x
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: install pnpm
        run: npm i -g pnpm
      - name: bootstrap monorepo
        run: pnpm i -r
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.AUTH_TOKEN }}
        run: pnpm run publish-all
      # now merge release-master into master and push master
      - name: checkout master
        run: git checkout master
      - name: merge release-master into master
        run: git merge release-master
      - name: push master with new tags
        run: git push origin master --follow-tags
      # now merge master into develop and push develop
      - name: checkout develop
        run: git checkout develop
      - name: update develop
        run: git pull
      - name: merge master into develop
        run: git merge master
      - name: push develop with all tags
        run: git push origin develop

